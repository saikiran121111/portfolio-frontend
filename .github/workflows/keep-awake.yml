name: Keep Backend Awake

on:
  schedule:
    - cron: '*/5 * * * *' # Every 5 min — prevents Render free tier from sleeping (sleeps after 15 min inactivity)
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Vercel wake-up endpoint (with retries for cold start)
        env:
          WAKE_UP_URL: ${{ secrets.WAKE_UP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          MAX_RETRIES=5
          RETRY_DELAY=30        # seconds between retries
          CURL_TIMEOUT=60       # give Render time to cold-start

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time $CURL_TIMEOUT \
              -H "Authorization: Bearer $CRON_SECRET" \
              "$WAKE_UP_URL") || true

            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
              echo " Success! Got HTTP $HTTP_STATUS"
              exit 0
            fi

            echo "  Got HTTP $HTTP_STATUS — Render may be waking up..."

            if [ "$i" -lt "$MAX_RETRIES" ]; then
              echo " Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done

          echo " All $MAX_RETRIES attempts failed. Render may be down."
          exit 1
